#!/bin/bash
# Pre-commit hook: Enforce API Gateway Pattern (Phase 3)
# Prevents commits with direct API calls outside durion-positivity component
# 
# Ref: ADR-0010 - Frontend Domain Responsibilities
# https://github.com/louisburroughs/durion/blob/master/docs/adr/0010-frontend-domain-responsibilities-guide.adr.md

set -e

echo "üîç Running API Gateway Enforcement Checks..."
echo ""

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|js|vue)$' || true)

if [ -z "$STAGED_FILES" ]; then
  echo "‚úÖ No TypeScript/Vue files to check"
  exit 0
fi

VIOLATIONS_FOUND=0

# Check for direct fetch() calls (excluding durion-positivity)
echo "Checking for direct fetch() calls..."
FETCH_VIOLATIONS=$(echo "$STAGED_FILES" | while read file; do
  if [[ "$file" == *"durion-positivity/webapp"* ]]; then
    continue
  fi
  
  if grep -n "fetch(" "$file" 2>/dev/null | grep -v "usePositivityApiClient" | grep -v "node_modules"; then
    echo "  ‚ùå $file: Direct fetch() call"
    return 1
  fi
done || true)

if [ -n "$FETCH_VIOLATIONS" ]; then
  echo "‚ùå Found direct fetch() calls:"
  echo "$FETCH_VIOLATIONS"
  VIOLATIONS_FOUND=1
fi

# Check for direct axios imports
echo "Checking for direct axios imports..."
AXIOS_VIOLATIONS=$(echo "$STAGED_FILES" | while read file; do
  if [[ "$file" == *"durion-positivity/webapp"* ]]; then
    continue
  fi
  
  if grep -n "from 'axios'" "$file" 2>/dev/null || grep -n 'from "axios"' "$file" 2>/dev/null; then
    echo "  ‚ùå $file: Direct axios import"
    return 1
  fi
done || true)

if [ -n "$AXIOS_VIOLATIONS" ]; then
  echo "‚ùå Found direct axios imports:"
  echo "$AXIOS_VIOLATIONS"
  VIOLATIONS_FOUND=1
fi

# Check for manual Authorization headers
echo "Checking for manual Authorization headers..."
AUTH_VIOLATIONS=$(echo "$STAGED_FILES" | while read file; do
  if [[ "$file" == *"durion-positivity/webapp"* ]]; then
    continue
  fi
  
  if grep -nE "'Authorization':|\"Authorization\":" "$file" 2>/dev/null | grep -E "Bearer|Token"; then
    echo "  ‚ùå $file: Manual Authorization header"
    return 1
  fi
done || true)

if [ -n "$AUTH_VIOLATIONS" ]; then
  echo "‚ùå Found manual Authorization headers:"
  echo "$AUTH_VIOLATIONS"
  VIOLATIONS_FOUND=1
fi

# Check that durion-* components use usePositivityApiClient or have no API calls
echo "Checking for proper API gateway usage..."
GATEWAY_VIOLATIONS=$(echo "$STAGED_FILES" | while read file; do
  # Only check durion-* component webapp files
  if [[ ! "$file" =~ durion-.*\/webapp ]] || [[ "$file" == *"durion-positivity/webapp"* ]]; then
    continue
  fi
  
  # Check for fetch or axios without durion-positivity import
  if (grep -q "fetch(" "$file" || grep -q "axios" "$file") && ! grep -q "usePositivityApiClient" "$file"; then
    echo "  ‚ùå $file: API calls without durion-positivity gateway"
    return 1
  fi
done || true)

if [ -n "$GATEWAY_VIOLATIONS" ]; then
  echo "‚ùå Found API calls without gateway:"
  echo "$GATEWAY_VIOLATIONS"
  VIOLATIONS_FOUND=1
fi

# Report results
echo ""
if [ $VIOLATIONS_FOUND -eq 1 ]; then
  echo "‚ùå COMMIT REJECTED: Architecture violations detected"
  echo ""
  echo "üìã Required Pattern (ADR-0010):"
  echo "   import { usePositivityApiClient } from 'durion-positivity';"
  echo "   const apiClient = usePositivityApiClient();"
  echo "   const result = await apiClient.request({"
  echo "     service: 'your-service',"
  echo "     endpoint: '/your/endpoint',"
  echo "     method: 'POST',"
  echo "     data: requestData"
  echo "   });"
  echo ""
  echo "üìñ See: https://github.com/louisburroughs/durion/blob/master/docs/adr/0010-frontend-domain-responsibilities-guide.adr.md"
  echo ""
  echo "‚úÖ To bypass (not recommended):"
  echo "   git commit --no-verify"
  exit 1
else
  echo "‚úÖ All API Gateway checks passed"
  exit 0
fi
